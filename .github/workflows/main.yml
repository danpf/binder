name: build
on:
  push:
    branches:
      - master

jobs:
  compilejobUbuntu:
    runs-on: ubuntu-latest
    name: Binder_on_Ubuntu
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Prepare ccache timestamp
      id: ccache_cache_timestamp
      shell: cmake -P {0}
      run: |
        string(TIMESTAMP current_date "%Y-%m-%d-%H;%M;%S" UTC)
        message("::set-output name=timestamp::${current_date}")

    - name: ccache cache files
      uses: actions/cache@v3
      env:
        cache-name: cache-ccache
      with:
        path: ${{ github.workspace }}/docker/cache
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${ { steps.ccache_cache_timestamp.outputs.timestamp } }
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build-01
      uses: docker/build-push-action@v3
      with:
        target: incremental-01
        push: false
        file: docker/Dockerfile
        build-args: |
          NCPUS=4

    - name: Build-02
      uses: docker/build-push-action@v3
      timeout-minutes: 1000
      with:
        target: incremental-02
        push: false
        file: docker/Dockerfile
        build-args: |
          NCPUS=4

    - name: Build-03
      uses: docker/build-push-action@v3
      with:
        target: final
        push: false
        file: docker/Dockerfile
        build-args: |
          NCPUS=4

    - name: Build-test
      uses: docker/build-push-action@v3
      with:
        target: test
        push: false
        file: docker/Dockerfile
        build-args: |
          NCPUS=4

  compilejobFedora35:
    runs-on: ubuntu-latest
    name: Binder_on_Fedora35
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Compile
      id: compileindocker
      uses: ./.github/workflows/fedora35
    - name: Get the output status
      run: exit ${{ steps.compileindocker.outputs.out }}

  compilejobOSX:
    runs-on: macos-latest
    name: Binder_on_OSX
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Compile
      id: compile
      run: ./.github/workflows/osx/entrypoint.sh
    - name: Get the output status
      run: exit ${{ steps.compile.outputs.out }}
